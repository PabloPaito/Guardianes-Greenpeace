<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Guardians Admin</title>
    <link href="uploadfile.css" rel="stylesheet" />
    <script src="jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="jquery.base64.js" type="text/javascript"></script>
    <script src="jquery.uploadfile.min.js" type="text/javascript"></script>

    <style>
        body {
            font-family: Helvetica, Arial, "Lucida Grande", sans-serif;
        }

        .tdnumber {
            text-align: right;
        }

        .tdcheck {
            text-align: center;
        }

        .url {
            width: 300px;
        }

        .label {
            float: left;
            width: 96px;
            margin-left: 0px;
        }

        #hourInput {
            width: 40px;
        }

        #minutesInput {
            width: 40px;
        }

        #descriptionInput {
            width: 400px;
            height: 150px;
        }
    </style>
</head>
<body>
    <h3>Administrator - Daily Messages</h3>
    <br />
    <br />
    <div style="padding-bottom:3px;">
        <p style="display:inline;">Username:</p>
        <input type="text" id="tbUsername" value="" />
    </div>
    <div>
        <p style="display:inline; padding-right:3px;">Password:</p>
        <input type="password" id="tbPassword" value="" />
    </div>
    <br />

    <input id="LoadDailyMessages" type="button" value="Load Values" />
    <br />
    <h4>Add Message</h4>
    <div>
        <div style="float: left;">

            <div class="label">Short title</div>
            <div>
                <input id="shortTitle" />
            </div>

            <br />

            <div class="label">Title</div>
            <div>
                <input id="title" />
            </div>

            <br />

            <div class="label">Description</div>
            <div>
                <textarea id="descriptionInput"></textarea>
            </div>

            <br />

            <div class="label">Region</div>
                <div><select id="regionSelect"></select></div>
                <br />
                <br />
                <div id="fileuploader">Upload Image</div>
                <script>
                    $(document).ready(function () {
                        $("#fileuploader").uploadFile({
                            url: "upload.php",
                            fileName: "myfile",
                            maxFileSize: 1000000,
                            onSuccess: function (files, data, xhr) {
                                $('#imageUrlInput').val(files[0]);
                                //files: list of files
                                //data: response from server
                                //xhr : jquer xhr object
                            }
                        });
                    });
                </script>
                <input id="imageUrlInput" type="hidden" name="imageUrlInput" />

                <br />

                <input id="addDailyMessage" type="button" value="Add" />
            </div>

        <div style="float: left; margin-left: 10px; border: solid 1px #CCCCCC; padding: 10px">

            <label><b>Start Date: </b></label>
            <br />
            <br />

            <div class="label">Day</div>
            <div>
                <select id="dayInput">
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                </select>
            </div>

            <br />

            <div class="label">Month</div>
            <div>
                <select id="monthInput">
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
            </div>

            <br />

            <div class="label">Year</div>
            <div>
                <input id="yearInput" value="2015" style="width: 60px" />
            </div>

            <br />

            <div class="label">Hour</div>
            <div>
                <select id="hourInput">
                    <option value="00">00</option>
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                </select>
            </div>

            <br />

            <div class="label">Minutes</div>
            <div>
                <select id="minutesInput">
                    <option value="00">00</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="50">50</option>
                </select>
            </div>

        </div>

        <div style="float: left; margin-left: 10px; border: solid 1px #CCCCCC; padding: 10px">

            <label><b>End Date: </b></label>

            <br />
            <br />

            <div class="label">Day</div>
            <div>
                <select id="enddayInput">
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="26">26</option>
                    <option value="27">27</option>
                    <option value="28">28</option>
                    <option value="29">29</option>
                    <option value="30">30</option>
                    <option value="31">31</option>
                </select>
            </div>

            <br />

            <div class="label">Month</div>
            <div>
                <select id="endmonthInput">
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                </select>
            </div>

            <br />

            <div class="label">Year</div>
            <div>
                <input id="endyearInput" value="2015" style="width: 60px" />
            </div>

            <br />

            <div class="label">Hour</div>
            <div>
                <select id="endhourInput">
                    <option value="00">00</option>
                    <option value="01">01</option>
                    <option value="02">02</option>
                    <option value="03">03</option>
                    <option value="04">04</option>
                    <option value="05">05</option>
                    <option value="06">06</option>
                    <option value="07">07</option>
                    <option value="08">08</option>
                    <option value="09">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                </select>
            </div>

            <br />

            <div class="label">Minutes</div>
            <div>
                <select id="endminutesInput">
                    <option value="00">00</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="40">40</option>
                    <option value="50">50</option>
                </select>
            </div>

        </div>

    </div>
    <div style="clear: both;"></div>
    <div style="margin-top: 20px">
        <h4>Message List</h4>
        <table border="1" cellpadding="6" cellspacing="0">
            <thead>
                <tr style="background-color: #cecece">
                    <td>Start Date</td>
                    <td>End Date</td>
                    <td>Short Title</td>
                    <td>Title</td>
                    <td>Description</td>
                    <td>Region</td>
                    <td>Image</td>
                    <td></td>
                </tr>
            </thead>
            <tbody id="MessagesTable">
            </tbody>
        </table>
        <br />
        <a href="index.html">back</a>
    </div>

    <script type="text/javascript">
        function getAuthString() {
            return "Basic " + $.base64Encode(document.getElementById("tbUsername").value + ":" + document.getElementById("tbPassword").value);
        }

        var regionList = new Array();

        function getRegionsSelect(action) {
            //Cargo el regionSelect
            $.ajax({
                type: "GET",
                url: "../api/region/getall",
                contentType: "application/json ; charset=utf-8",
                //dataType: "json",
                success: function (items) {
                    $.each(items, function (i, item) {
                        regionList[item.Id] = item.Name;
                        if (action == "add") {
                            $('#regionSelect').append($('<option>', {
                                value: item.Id,
                                text: item.Name
                            }));
                        }
                    });
                },
                error: function (xhr, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        function LoadDailyMessages() {
            $('#MessagesTable').html('');

            $.ajax({
                cache: false,
                type: "GET",
                data: "{\"Name\":\"" + document.getElementById("tbUsername").value + "\",\"Password\":\"" + document.getElementById("tbPassword").value + "\" }",
                url: "../api/popupmessages/getall",
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", getAuthString());
                },
                contentType: "application/json ; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $(result).each(function ()
                    {
                        var stDate = new Date(parseInt($(this).attr('StartDate').substr(6))).toLocaleDateString();
                        var stDate1 = new Date(parseInt($(this).attr('StartDate').substr(6))).toLocaleTimeString();

                        var ndDate = new Date(parseInt($(this).attr('EndDate').substr(6))).toLocaleDateString();
                        var ndDate1 = new Date(parseInt($(this).attr('EndDate').substr(6))).toLocaleTimeString();

                        var html =
                          '<td>' + stDate + "  " + stDate1 + '</td>'
                        + '<td>' + ndDate + "  " + ndDate1 + '</td>'
                        + '<td>' + $(this).attr('ShortTitle') + '</td>'
                        + '<td>' + $(this).attr('Title') + '</td>'
                        + '<td>' + $(this).attr('Description') + '</td>'
                        + '<td>' + regionList[$(this).attr('RegionId')] + '</td>'
                        + '<td><img src="http://guardianes.greenpeace.org.ar/SatelliteImages/messages/' + $(this).attr('ImageURL') + '" style="width: 100px;" /></td>'
                        //+ '<td><img width="100" src=" ../SatelliteImages/messages/' + $(this).attr('ImageURL') + '" /></td>'

                      + '<td><a href="#" onclick="deleteDailyMessage(' + $(this).attr('Id') + ');" title="Delete Message">X</a>';
                        $('<tr></tr>').html(html).appendTo('#MessagesTable');
                    });
                },
                error: function (xhr, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        function deleteDailyMessage(id) {
            if (id == "") {
                alert("error");
                return false;
            }

            if (confirm('Are you sure you want to delete this message?')) {
                $.ajax({
                    type: 'POST',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("Authorization", getAuthString());
                    },
                    url: "../api/popupmessages/del",
                    data: JSON.stringify(id),
                    dataType: "json",
                    contentType: 'application/json; charset=utf-8',
                    success: function (result) {
                        alert('Successful Operation!');
                        LoadDailyMessages();
                    },
                    error: function (xhr, textStatus, errorThrown) {

                        if (xhr.status = 200) //Tira un error de sintaxis al agregar la carga de la imagen
                        {
                            alert('Successful Operation!');
                            LoadDailyMessages();
                        }
                        else
                        {
                            alert(errorThrown);
                            LoadDailyMessages();
                        }
                    }
                });
            }
        }

        $(document).ready(function () {

            getRegionsSelect("add");

            $("#addDailyMessage").click(function () {
                var syear = $('#yearInput').val();
                var smonth = $('#monthInput').val();
                var sday = $('#dayInput').val();
                var shour = $('#hourInput').val();
                var sminutes = $('#minutesInput').val();
                var sdate = new Date(parseInt(syear), (parseInt(smonth) - 1), parseInt(sday), (parseInt(shour) - 3), parseInt(sminutes), 00, 0);

                var eyear = $('#endyearInput').val();
                var emonth = $('#endmonthInput').val();
                var eday = $('#enddayInput').val();
                var ehour = $('#endhourInput').val();
                var eminutes = $('#endminutesInput').val();
                var edate = new Date(parseInt(eyear), (parseInt(emonth) - 1), parseInt(eday), (parseInt(ehour) - 3), parseInt(eminutes), 00, 0);

                var shortTitle = $('#shortTitle').val();
                var title = $('#title').val();
                var description = $('#descriptionInput').val();
                var regionId = $('#regionSelect').val();
                var imageURL = $('#imageUrlInput').val();

                var eticks = edate.getTime();
                var sticks = sdate.getTime();

                if (edate > sdate)
                {
                        $.ajax({
                        type: "POST",
                        url: "../api/popupmessages/add",
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("Authorization", getAuthString());
                        },
                        data: JSON.stringify({
                            ShortTitle: shortTitle.toString(),
                            Title: title.toString(),
                            Description: description.toString(),
                            RegionId: regionId.toString(),
                            ImageURL: imageURL.toString(),
                            EndDate: "/Date(" + eticks.toString() + ")/",
                            StartDate: "/Date(" + sticks.toString() + ")/",
                        }),
                        contentType: "application/json ; charset=utf-8",
                        dataType: "json",
                        success: function () {
                            alert("Congratulations, new message added.");
                            LoadDailyMessages();
                        },
                        error: function (xhr, textStatus, errorThrown) {
                            alert("error, something went wrong adding the message");
                        }
                    });
                }
                else {
                    alert('Both dates must be different');
                }
            });

            $("#LoadDailyMessages").click(function () {
                LoadDailyMessages();
            });
        });

    </script>
</body>
</html>
